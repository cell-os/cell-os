#!/bin/bash
#list the zookeeper nodes, making sure that we have at least 3
source /etc/profile.d/cellos.sh
num_servers=${num_servers:-3}
code=$(curl -s -o /dev/null -w "%{http_code}" ${zk_cluster_list})
if (( code == 200 )); then
  # we have a 200, get the servers
  found=$(curl -H "Accept: application/json" ${zk_cluster_list} 2>/dev/null | jq ".servers | length")
  if (( $? == 0 )); then
    if (( $found < $num_servers )); then
      >&2 echo "not enough servers found ($found out of $num_servers)"
      exit 1
    fi
  else
    >&2 echo no servers found
    exit 1
  fi
else
  >&2 echo no servers found
  exit 1
fi

curl -H "Accept: application/json" ${zk_cluster_list} 2>/dev/null | jq -r '(.port | tostring) as $port | .servers | map(. + ":" + $port) | join(",")'
