#!/bin/bash
#blocks execution until we have a ZK quorum
source /etc/profile.d/cellos.sh
num_servers=3
while true; do
  code=$(curl -H "Accept: application/json" -s -o /dev/null -w "%{http_code}" "${zk_base_url}/cluster/status")
  if (( code == 200 )); then
    num_serving=$(curl -H "Accept: application/json" "${zk_base_url}/cluster/status" 2>/dev/null | jq '[.[] | select(.description == "serving")] | length')
    num_serving=${num_serving:-0}
    found=$(curl -H "Accept: application/json" ${zk_cluster_list} 2>/dev/null | jq ".servers | length")
    found=${found:-0}

    if (( $num_serving >= $num_servers && $found >= $num_servers )); then
      # check servers
      valid=()
      for hp in $(zk-list-nodes | sed 's/,/\n/g'); do
        host=$(echo $hp | sed 's/:.*$//')
        exec 6<>/dev/tcp/$host/2181 && valid+=($host)
      done
      if (( ${#valid[@]}  >= $num_servers )); then
        break
      else
        echo -n "."
        sleep 1
      fi
    else
      echo -n "."
      sleep 1
    fi
  else
    echo -n "."
    sleep 1
  fi
done
